<!DOCTYPE html>
<html>
<head>
  <title>OAuth Callback</title>
  <script>
    // Extract OAuth code or token from both search params and fragment
    const params = new URLSearchParams(window.location.search);
    let code = params.get('code');
    let accessToken = params.get('access_token');
    let error = params.get('error');
    let errorCode = params.get('error_code');
    let errorDescription = params.get('error_description');

    // Also check fragment (hash) for code/access_token/errors
    if (window.location.hash) {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      if (!code) code = hashParams.get('code');
      if (!accessToken) accessToken = hashParams.get('access_token');
      if (!error) error = hashParams.get('error');
      if (!errorCode) errorCode = hashParams.get('error_code');
      if (!errorDescription) errorDescription = hashParams.get('error_description');
    }

    console.log('OAuth callback parameters:', {
      code: code ? 'present' : 'missing',
      accessToken: accessToken ? 'present' : 'missing',
      error: error,
      errorCode: errorCode,
      errorDescription: errorDescription,
      fullURL: window.location.href
    });

    // Check for OAuth errors first
    if (error) {
      console.log('OAuth Error detected:', error, errorCode, errorDescription);
      
      let errorTitle = 'OAuth Login Failed';
      let errorMessage = 'An error occurred during login.';
      let userFriendlyMessage = '';
      let actionButtons = '';

      // Handle specific error types
      switch (error) {
        case 'access_denied':
          errorTitle = 'Login Cancelled';
          errorMessage = 'You cancelled the login process.';
          userFriendlyMessage = 'Please try logging in again if you want to continue.';
          actionButtons = `
            <button onclick="window.history.back()" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">
              Try Again
            </button>`;
          break;
          
        case 'server_error':
          if (errorDescription && errorDescription.includes('email')) {
            errorTitle = 'Email Access Required';
            errorMessage = 'Unable to access your email address from the social provider.';
            userFriendlyMessage = `
              This usually happens when:
              <br>â€¢ You didn't grant email permission during login
              <br>â€¢ Your social account doesn't have a verified email address
              <br>â€¢ The provider's privacy settings block email access
            `;
            actionButtons = `
              <button onclick="tryEmailFix()" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">
                Try Login Again
              </button>
              <button onclick="window.history.back()" style="background: #6c757d; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">
                Go Back
              </button>`;
          } else {
            errorTitle = 'Server Error';
            errorMessage = 'A server error occurred during login.';
            userFriendlyMessage = 'Please try again in a few moments. If the problem persists, contact support.';
            actionButtons = `
              <button onclick="window.history.back()" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">
                Try Again
              </button>`;
          }
          break;
          
        case 'temporarily_unavailable':
          errorTitle = 'Service Temporarily Unavailable';
          errorMessage = 'The login service is temporarily unavailable.';
          userFriendlyMessage = 'Please try again in a few minutes.';
          actionButtons = `
            <button onclick="window.history.back()" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">
              Try Again
            </button>`;
          break;
          
        default:
          errorTitle = 'Login Error';
          errorMessage = error.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          userFriendlyMessage = errorDescription ? decodeURIComponent(errorDescription) : 'An unexpected error occurred.';
          actionButtons = `
            <button onclick="window.history.back()" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">
              Try Again
            </button>`;
      }

      // Show error UI
      document.body.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px; text-align: center; max-width: 600px; margin: 0 auto;">
          <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 10px; padding: 30px; margin: 20px 0;">
            <h2 style="color: #721c24; margin: 0 0 15px 0;">ðŸš« ${errorTitle}</h2>
            <p style="color: #721c24; font-size: 18px; margin: 0 0 15px 0;">${errorMessage}</p>
            <div style="color: #721c24; font-size: 14px; line-height: 1.5;">
              ${userFriendlyMessage}
            </div>
          </div>
          
          <div style="margin: 30px 0;">
            ${actionButtons}
          </div>
          
          <details style="margin-top: 30px; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <summary style="cursor: pointer; font-weight: bold; margin-bottom: 10px;">Technical Details</summary>
            <div style="font-family: monospace; font-size: 12px; color: #495057;">
              <strong>Error:</strong> ${error}<br>
              <strong>Error Code:</strong> ${errorCode || 'N/A'}<br>
              <strong>Description:</strong> ${errorDescription || 'N/A'}<br>
              <strong>URL:</strong> ${window.location.href}
            </div>
          </details>
        </div>`;

      // Add JavaScript functions for error handling
      window.tryEmailFix = function() {
        alert('Tips for email access:\n\n1. Make sure you grant email permission when prompted\n2. Check that your social account has a verified email address\n3. Try using a different social provider\n4. Contact support if the problem persists');
        window.history.back();
      };

      return; // Stop processing if there's an error
    }

    // Detect if we're running in a mobile app (Capacitor) vs web browser
    const isMobileApp = window.location.protocol === 'capacitor:' || 
                        'Capacitor' in window ||
                        window.navigator.userAgent.includes('CapacitorWebView') ||
                        window.navigator.userAgent.includes('wv') || // Android WebView indicator
                        window.navigator.userAgent.includes('Mobile') ||
                        /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent);

    // Detect if we're in local development
    const isLocalDevelopment = window.location.hostname === 'localhost' ||
                               window.location.hostname === '127.0.0.1' ||
                               window.location.port === '8100' ||
                               window.location.port === '8101';

    console.log('Environment detection:', {
      protocol: window.location.protocol,
      hostname: window.location.hostname,
      port: window.location.port,
      userAgent: window.navigator.userAgent,
      isMobileApp: isMobileApp,
      isLocalDevelopment: isLocalDevelopment,
      hasCapacitor: 'Capacitor' in window
    });

    // For GitHub Pages URL accessed from mobile, always try deep link first
    const isGitHubPages = window.location.hostname === 'ledeuadian.github.io';
    const shouldDeepLink = isMobileApp || isGitHubPages;

    if (shouldDeepLink && !isLocalDevelopment) {
      // Try mobile deep link (works in mobile app or gets handled by system)
      console.log('Attempting deep link redirect...');
      
      // Add visual feedback
      document.getElementById('status').textContent = 'Redirecting to mobile app...';
      
      if (code) {
        console.log('Redirecting to deep link with code:', code);
        const deepLinkUrl = `com.groceryshop.app://oauth-callback?code=${code}`;
        
        // Multiple attempts to trigger deep link
        // Method 1: Direct window.location
        try {
          window.location.href = deepLinkUrl;
        } catch (e) {
          console.log('Method 1 failed:', e);
        }
        
        // Method 2: Create invisible iframe (works on some mobile browsers)
        setTimeout(() => {
          try {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = deepLinkUrl;
            document.body.appendChild(iframe);
            setTimeout(() => document.body.removeChild(iframe), 1000);
          } catch (e) {
            console.log('Method 2 failed:', e);
          }
        }, 100);
        
        // Method 3: Create a link and programmatically click it
        setTimeout(() => {
          try {
            const link = document.createElement('a');
            link.href = deepLinkUrl;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            setTimeout(() => document.body.removeChild(link), 1000);
          } catch (e) {
            console.log('Method 3 failed:', e);
          }
        }, 200);
        
        // Method 4: Try window.open
        setTimeout(() => {
          try {
            window.open(deepLinkUrl, '_system');
          } catch (e) {
            console.log('Method 4 failed:', e);
          }
        }, 300);
        
        // Fallback: if redirect doesn't work after 3 seconds, show manual options
        setTimeout(() => {
          document.body.innerHTML = `
            <div style="font-family: Arial, sans-serif; padding: 20px; text-align: center;">
              <h2>Opening Mobile App...</h2>
              <p>If the app didn't open automatically, please tap the button below:</p>
              <div style="margin: 20px 0;">
                <a href="${deepLinkUrl}" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; text-decoration: none; display: inline-block;">
                  Open in GroSho App
                </a>
              </div>
              <div style="background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 5px; font-family: monospace; word-break: break-all; font-size: 12px;">
                ${deepLinkUrl}
              </div>
              <button onclick="copyToClipboard('${deepLinkUrl}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                Copy Deep Link
              </button>
              <p style="margin-top: 20px; font-size: 14px; color: #666;">
                If the app still doesn't open, please:
                <br>1. Make sure the GroSho app is installed
                <br>2. Try copying the link and opening it in your browser's address bar
                <br>3. Contact support if the issue persists
              </p>
            </div>`;
        }, 3000);
        
      } else if (accessToken) {
        console.log('Redirecting to deep link with access token');
        const deepLinkUrl = `com.groceryshop.app://oauth-callback?access_token=${accessToken}`;
        
        // Multiple attempts to trigger deep link
        try {
          window.location.href = deepLinkUrl;
        } catch (e) {
          console.log('Method 1 failed:', e);
        }
        
        setTimeout(() => {
          try {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = deepLinkUrl;
            document.body.appendChild(iframe);
            setTimeout(() => document.body.removeChild(iframe), 1000);
          } catch (e) {
            console.log('Method 2 failed:', e);
          }
        }, 100);
        
        setTimeout(() => {
          try {
            const link = document.createElement('a');
            link.href = deepLinkUrl;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            setTimeout(() => document.body.removeChild(link), 1000);
          } catch (e) {
            console.log('Method 3 failed:', e);
          }
        }, 200);
        
        setTimeout(() => {
          try {
            window.open(deepLinkUrl, '_system');
          } catch (e) {
            console.log('Method 4 failed:', e);
          }
        }, 300);
        
        // Same fallback for access token
        setTimeout(() => {
          document.body.innerHTML = `
            <div style="font-family: Arial, sans-serif; padding: 20px; text-align: center;">
              <h2>Opening Mobile App...</h2>
              <p>If the app didn't open automatically, please tap the button below:</p>
              <div style="margin: 20px 0;">
                <a href="${deepLinkUrl}" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; text-decoration: none; display: inline-block;">
                  Open in GroSho App
                </a>
              </div>
              <div style="background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 5px; font-family: monospace; word-break: break-all; font-size: 12px;">
                ${deepLinkUrl}
              </div>
              <button onclick="copyToClipboard('${deepLinkUrl}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                Copy Deep Link
              </button>
              <p style="margin-top: 20px; font-size: 14px; color: #666;">
                If the app still doesn't open, please:
                <br>1. Make sure the GroSho app is installed
                <br>2. Try copying the link and opening it in your browser's address bar
                <br>3. Contact support if the issue persists
              </p>
            </div>`;
        }, 3000);
        
      } else {
        document.body.innerHTML = '<h2>No OAuth code or token found.</h2>';
      }
    } else if (isLocalDevelopment) {
      // Local development - redirect to React app route
      console.log('Local development detected, redirecting to React route');
      const currentUrl = new URL(window.location.href);
      const newUrl = `${window.location.origin}/oauth-callback${currentUrl.search}${currentUrl.hash}`;
      window.location.href = newUrl;
    } else {
      // Web browser accessing GitHub Pages - show instructions to open in mobile app
      console.log('Web browser detected on production URL');
      document.body.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px; text-align: center;">
          <h2>Mobile App Login</h2>
          <p>This OAuth callback is designed for the mobile app.</p>
          <p>Please open this link in the GroSho mobile app:</p>
          <div style="background: #f0f0f0; padding: 10px; margin: 20px 0; border-radius: 5px;">
            <code>com.groceryshop.app://oauth-callback${window.location.search}${window.location.hash}</code>
          </div>
          <p><strong>Or copy this URL and paste it into your mobile app:</strong></p>
          <button onclick="copyToClipboard()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            Copy Mobile App URL
          </button>
          <p style="margin-top: 20px; font-size: 12px; color: #666;">
            If you're trying to test the web version, please use localhost:8100 or localhost:8101
          </p>
        </div>`;
        
        // Add the copy function
        window.copyToClipboard = function() {
          const url = `com.groceryshop.app://oauth-callback${window.location.search}${window.location.hash}`;
          navigator.clipboard.writeText(url).then(() => {
            alert('Mobile app URL copied to clipboard!');
          }).catch(() => {
            prompt('Copy this URL:', url);
          });
        };
    }
    
    // Global copy function
    window.copyToClipboard = function(url) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          alert('Deep link copied to clipboard!');
        }).catch(() => {
          prompt('Copy this URL:', url);
        });
      } else {
        prompt('Copy this URL:', url);
      }
    };
  </script>
</head>
<body>
  <div id="status">Processing OAuth callback...</div>
</body>
</html>
